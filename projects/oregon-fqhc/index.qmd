---
title: "Oregon FQHC Landscape"
subtitle: "Automated analysis of Health Center Service Delivery Sites"
author: "E. Pitzer"
date: last-modified
categories: [Data Engineering, Healthcare, Python]
format:
  html:
    code-fold: true
    toc: true
    page-layout: full
jupyter: python3
---

## Project Status
**Phase 2: Geospatial & Search** | [View Technical Architecture &rarr;](about.qmd)

Data is sourced directly from the [HRSA Data Warehouse](https://data.hrsa.gov/).

```{python}
#| label: setup
#| warning: false
#| echo: false

import pandas as pd
import seaborn as sns
import matplotlib.pyplot as plt
import plotly.express as px
from itables import show

# Load the processed data
df = pd.read_csv("data/processed/oregon_sites.csv")

# Quick metric for the dashboard
total_sites = len(df)
unique_cities = df['city'].nunique()
unique_orgs = df['organization'].nunique()
```

### At a Glance

We are currently tracking **`{python} total_sites`** service delivery sites across **`{python} unique_cities`** cities in Oregon.

### Sites by County (Top 10)

Where are the health center sites concentrated?

```{python}
#| label: fig-county-dist
#| fig-cap: "Distribution of FQHC Sites by County"
#| warning: false

# Configure the visual style
sns.set_theme(style="whitegrid")
plt.figure(figsize=(10, 6))

# Count sites per county - USING CORRECTED COLUMN NAME
county_counts = df['county'].value_counts().head(10).reset_index()
county_counts.columns = ['County', 'Sites']

# Plot
ax = sns.barplot(data=county_counts, x='Sites', y='County', palette="viridis", hue='County')
ax.set_title("Top 10 Counties by Number of Sites")
plt.show()
```

### Interactive Map

Hover over points to see site details.

```{python}
#| label: fig-map
#| fig-cap: "Map of Health Center Service Delivery Sites"
#| warning: false

# Define a custom color sequence if you want specific branding, 
# otherwise Plotly handles it automatically.

fig = px.scatter_mapbox(
    df, 
    lat="latitude", 
    lon="longitude", 
    hover_name="site_name",
    hover_data=["organization", "city", "county"],
    color="organization", 
    zoom=5.5, 
    center={"lat": 44.0, "lon": -120.5},
    height=600,
    title="Oregon FQHC Sites by Organization"
)

fig.update_layout(
    mapbox_style="open-street-map",
    margin={"r":0,"t":40,"l":0,"b":0},
    legend=dict(
        orientation="h",       # Horizontal
        yanchor="top",         # Anchor the top of the legend...
        y=-0.05,               # ...just below the map
        xanchor="center",      # Center it
        x=0.5,
        title=None,            # REMOVE the title (fixes the "zation" cutoff)
        font=dict(size=9),     # Smaller font to fit more items
        itemsizing='constant'
    )
)
fig.show()
```

### Search & Explore Data

Use the search bar below to find specific clinics, cities, or organizations.
```{python}
#| label: tbl-interactive
#| warning: false

# Display interactive table with search
show(df[['organization', 'site_name', 'city', 'county', 'type']], 
     classes="display nowrap compact", 
     paging=True, 
     searching=True) # <--- Enables the Search Bar
```

### Data Preview

Below is a sample of the raw data feeding this report.

```{python}
#| label: tbl-preview
#| tbl-cap: "Recent Site Data Entry"

# Display a clean table of just a few relevant columns
# USING CORRECTED COLUMN NAME
display_cols = ['site_name', 'city', 'county', 'type']
df[display_cols].sample(5)
```