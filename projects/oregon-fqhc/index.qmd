---
title: "Oregon FQHC Landscape"
subtitle: "Automated analysis of Health Center Service Delivery Sites"
author: "E. Pitzer"
date: last-modified
categories: [Data Engineering, Healthcare, Python]
format:
  html:
    code-fold: true
    toc: true
    page-layout: full
jupyter: python3
---

## Project Status
**Phase 3: Patient Demographics Integration** | [View Technical Architecture &rarr;](about.qmd)

Data sourced from [HRSA Data Warehouse](https://data.hrsa.gov/) (Site Locations) and **2024 UDS Table 4** (Patient Demographics).

```{python}
#| label: setup
#| warning: false
#| echo: false

import pandas as pd
import plotly.express as px
from itables import show

# Load the NEW Joined Data
df = pd.read_csv("data/processed/oregon_sites_joined.csv")

# Fill NaNs for visualization
df['total_patients'] = df['total_patients'].fillna(0)
df['pct_medicaid'] = df['pct_medicaid'].fillna(0)

# Create formatted columns for the tooltip
df['Patients (fmt)'] = df['total_patients'].apply(lambda x: f"{x:,.0f}")
df['Medicaid %'] = df['pct_medicaid'].apply(lambda x: f"{x:.1%}")

# Quick metrics
total_sites = len(df)
total_patients_served = df['total_patients'].sum()
# --- NEW METRIC ---
unique_orgs = df['organization'].nunique()
```

### At a Glance

We are currently tracking **`{python} total_sites`** service delivery sites operated by **`{python} unique_orgs`** organizations.

Collectively, these centers serve approximately **`{python} f"{total_patients_served:,.0f}"`** patients across Oregon.

### Interactive Map

- Size: Total Patients Served
- Color: Percent of Patients on Medicaid
- Hover for details.

```{python}
#| label: fig-map
#| fig-cap: "Map of Health Center Sites (Sized by Patient Volume)"
#| warning: false

fig = px.scatter_mapbox(
    df, 
    lat="latitude", 
    lon="longitude", 
    hover_name="site_name",
    hover_data={
        "latitude": False,
        "longitude": False,
        "total_patients": False, # <--- Hide the raw size column
        "pct_medicaid": False,   # <--- Hide the raw color column
        "organization": True,
        "city": True,
        "Patients (fmt)": True,  # Keep the pretty version
        "Medicaid %": True       # Keep the pretty version
    },
    size="total_patients",
    color="pct_medicaid",
    color_continuous_scale="Viridis", 
    size_max=25,
    zoom=5.5, 
    center={"lat": 44.0, "lon": -120.5},
    height=600,
    title="Oregon FQHCs: Patient Volume & Medicaid Density"
)

fig.update_layout(
    mapbox_style="carto-positron",
    margin={"r":0,"t":40,"l":0,"b":0},
    coloraxis_colorbar=dict(
        title="% Medicaid",
        thickness=15,
        len=0.5,
        yanchor="bottom", y=0.1,
        xanchor="left", x=0.02,
        bgcolor="rgba(255,255,255,0.8)"
    )
)
fig.show()
```

### Search & Explore Data

Sort by Uninsured or Medicaid to find high-need areas.
```{python}
#| label: tbl-interactive
#| warning: false

# Select columns for the table
display_cols = ['organization', 'site_name', 'city', 'total_patients', 'pct_medicaid', 'pct_uninsured']

# Create a clean copy for display
df_display = df[display_cols].copy()

# Rename for readability
df_display.columns = ['Organization', 'Site', 'City', 'Total Patients', '% Medicaid', '% Uninsured']

# Format percentages for the table display (0.5 -> 50%)
# Note: This turns them into strings, which might affect numeric sorting in some table libraries, 
# but it looks better.
df_display['% Medicaid'] = df_display['% Medicaid'].apply(lambda x: f"{x:.1%}")
df_display['% Uninsured'] = df_display['% Uninsured'].apply(lambda x: f"{x:.1%}")

show(df_display, 
     classes="display nowrap compact", 
     paging=True, 
     searching=True)
```

### Data Preview

Below is a sample of the raw data feeding this report.

```{python}
#| label: tbl-preview
#| tbl-cap: "Recent Site Data Entry"

# Display a clean table of just a few relevant columns
# USING CORRECTED COLUMN NAME
display_cols = ['site_name', 'city', 'county', 'type']
df[display_cols].sample(5)
```